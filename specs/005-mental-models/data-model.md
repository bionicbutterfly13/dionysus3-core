# Data Model: Mental Model Architecture

**Feature**: 005-mental-models
**Date**: 2025-12-16
**Source**: [spec.md](./spec.md), [design.md](./design.md)

## Entity Overview

```
┌─────────────────────┐     ┌─────────────────────┐
│   mental_models     │────<│  model_predictions  │
│                     │     │                     │
│ - constituent_basins│     │ - prediction        │
│ - prediction_templates    │ - observation       │
│ - prediction_accuracy     │ - prediction_error  │
└──────────┬──────────┘     └─────────┬───────────┘
           │                          │
           │                          │
           ▼                          ▼
┌─────────────────────┐     ┌─────────────────────┐
│  model_revisions    │     │active_inference_states│
│                     │     │     (existing)      │
│ - trigger_type      │     │ + source_model_id   │
│ - old_structure     │     └─────────────────────┘
│ - new_structure     │
└─────────────────────┘
           │
           ▼
┌─────────────────────┐
│  memory_clusters    │
│     (existing)      │
│                     │
│ - attractor basins  │
└─────────────────────┘
```

## Entities

### MentalModel

A structured combination of memory basins that generates predictions.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| id | UUID | Yes (auto) | Primary key |
| name | string | Yes | Human-readable model name |
| domain | enum | Yes | Model type: 'user', 'self', 'world', 'task_specific' |
| description | string | No | Detailed description of what model represents |
| constituent_basins | UUID[] | Yes | References to memory_clusters (attractor basins) |
| basin_relationships | JSONB | No | How basins relate (causal, temporal, hierarchical) |
| prediction_templates | JSONB[] | No | Patterns the model can predict |
| explanatory_scope | string[] | No | What phenomena this model explains |
| requires_sensory_input | boolean | No | Whether model needs real-time input (default: false) |
| temporal_horizon | interval | No | How far ahead model can predict |
| evidence_memories | UUID[] | No | Episodic memories supporting this model |
| prediction_accuracy | float | No | Rolling accuracy score (0.0-1.0, default: 0.5) |
| last_validated | timestamp | No | When accuracy was last calculated |
| revision_count | integer | No | Number of revisions (default: 0) |
| status | enum | No | Lifecycle: 'draft', 'active', 'deprecated' (default: 'draft') |
| created_at | timestamp | Yes (auto) | Creation timestamp |
| updated_at | timestamp | Yes (auto) | Last modification timestamp |

**Validation Rules**:
- `name` must be non-empty, max 255 characters
- `domain` must be one of: 'user', 'self', 'world', 'task_specific'
- `constituent_basins` must contain at least one valid `memory_clusters.id`
- `prediction_accuracy` must be between 0.0 and 1.0
- `status` must be one of: 'draft', 'active', 'deprecated'

**State Transitions**:
```
draft → active    (manual activation)
active → deprecated (manual deprecation or auto via high error)
deprecated → active (manual reactivation)
```

### ModelPrediction

A specific prediction generated by a model.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| id | UUID | Yes (auto) | Primary key |
| model_id | UUID | Yes | Reference to mental_models |
| prediction | JSONB | Yes | The prediction content |
| confidence | float | No | Model confidence (0.0-1.0, default: 0.5) |
| context | JSONB | No | What prompted this prediction |
| observation | JSONB | No | Actual outcome (set on resolution) |
| prediction_error | float | No | Calculated error (set on resolution) |
| resolved_at | timestamp | No | When prediction was resolved |
| inference_state_id | UUID | No | Reference to active_inference_states |
| created_at | timestamp | Yes (auto) | Creation timestamp |

**Validation Rules**:
- `model_id` must reference existing `mental_models.id`
- `confidence` must be between 0.0 and 1.0
- `prediction_error` must be between 0.0 and 1.0 when set
- If `resolved_at` is set, `observation` and `prediction_error` must also be set

**Lifecycle**:
```
Created (prediction made)
    │
    ▼
Unresolved (waiting for outcome)
    │
    ├── Resolved (observation matched, error calculated)
    │
    └── Timed Out (TTL expired, no observation)
```

### ModelRevision

Historical record of changes to a model's structure.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| id | UUID | Yes (auto) | Primary key |
| model_id | UUID | Yes | Reference to mental_models |
| trigger_type | enum | Yes | What caused revision |
| trigger_memory_id | UUID | No | Memory that triggered revision |
| trigger_description | string | No | Human-readable trigger explanation |
| old_structure | JSONB | No | Model structure before revision |
| new_structure | JSONB | No | Model structure after revision |
| basins_added | UUID[] | No | Basins added in this revision |
| basins_removed | UUID[] | No | Basins removed in this revision |
| change_description | string | No | Summary of what changed |
| prediction_error_before | float | No | Model accuracy before revision |
| prediction_error_after | float | No | Model accuracy after revision |
| created_at | timestamp | Yes (auto) | Revision timestamp |

**Trigger Types**:
- `prediction_error` - High error rate triggered automatic revision
- `new_evidence` - New memory contradicted model predictions
- `contradiction` - Model conflicts with other models
- `manual` - Human-triggered revision

**Validation Rules**:
- `model_id` must reference existing `mental_models.id`
- `trigger_type` must be one of: 'prediction_error', 'new_evidence', 'contradiction', 'manual'

### BasinRelationship (Embedded JSONB)

Describes how constituent basins relate within a model. Stored in `mental_models.basin_relationships`.

```json
{
  "relationships": [
    {
      "from_basin": "uuid-1",
      "to_basin": "uuid-2",
      "type": "causal",
      "strength": 0.8,
      "description": "Basin 1 causes activation of Basin 2"
    },
    {
      "from_basin": "uuid-2",
      "to_basin": "uuid-3",
      "type": "temporal",
      "strength": 0.6,
      "description": "Basin 2 typically precedes Basin 3"
    }
  ]
}
```

**Relationship Types**:
- `causal` - One basin causes another
- `temporal` - One basin precedes another in time
- `hierarchical` - One basin is a subtype of another
- `associated` - Co-activation pattern without clear causality

### PredictionTemplate (Embedded JSONB)

Pattern for generating predictions. Stored in `mental_models.prediction_templates`.

```json
{
  "trigger": "user mentions work stress",
  "predict": "likely experiencing anxiety about performance",
  "suggest": "acknowledge feelings before problem-solving",
  "confidence_modifier": 0.1,
  "applicable_domains": ["user", "emotional"]
}
```

## Indexes

| Table | Index | Type | Purpose |
|-------|-------|------|---------|
| mental_models | domain | B-tree | Filter by model type |
| mental_models | status (partial: active) | B-tree | Fast retrieval of active models |
| mental_models | constituent_basins | GIN | Find models containing specific basins |
| model_predictions | model_id | B-tree | Predictions by model |
| model_predictions | resolved_at (partial: NULL) | B-tree | Unresolved predictions |
| model_revisions | model_id | B-tree | Revision history by model |
| model_revisions | trigger_type | B-tree | Filter by trigger type |

## Views

### active_models_summary

Provides statistics for active models.

| Column | Description |
|--------|-------------|
| id | Model ID |
| name | Model name |
| domain | Model domain |
| prediction_accuracy | Rolling accuracy |
| basin_count | Number of constituent basins |
| revision_count | Number of revisions |
| total_predictions | Lifetime prediction count |
| avg_error | Average prediction error (resolved only) |
| last_prediction | Most recent prediction timestamp |

### models_needing_revision

Lists models with high error rates that should be revised.

| Column | Description |
|--------|-------------|
| id | Model ID |
| name | Model name |
| domain | Model domain |
| recent_avg_error | Average error over last 7 days |
| recent_predictions | Prediction count in last 7 days |

**Filter Criteria**: Average error > 0.5 over last 7 days

## Relationships

```
mental_models
    │
    ├── 1:N → model_predictions (model_id)
    │
    ├── 1:N → model_revisions (model_id)
    │
    ├── N:M → memory_clusters (constituent_basins array)
    │
    └── N:M → memories (evidence_memories array)

model_predictions
    │
    └── N:1 → active_inference_states (inference_state_id)

active_inference_states
    │
    └── N:1 → mental_models (source_model_id) [NEW COLUMN]
```

## Migration Notes

1. **New Tables**: mental_models, model_predictions, model_revisions
2. **Altered Tables**: active_inference_states (add source_model_id column)
3. **No Breaking Changes**: All additions are optional/nullable
4. **Rollback**: Drop new tables, drop new column from active_inference_states
