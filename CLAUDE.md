# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Dionysus is a VPS-native cognitive engine for autonomous reasoning, long-term session continuity, and structured memory management. It implements consciousness-inspired patterns using active inference, attractor basins, and OODA-style decision loops.

## Build & Deploy

```bash
# Deploy on VPS
docker compose up -d --build

# Local development
pip install -r requirements.txt
uvicorn api.main:app --reload --port 8000
```

## Testing

```bash
# Unit tests (local)
python -m pytest tests/unit/ -v

# Single test file
python -m pytest tests/unit/test_heartbeat_agent.py -v

# VPS integration tests (run inside container)
docker exec dionysus-api python3 /app/scripts/test_memevolve_recall.py
docker exec dionysus-api python3 /app/scripts/test_memevolve_ingest.py
docker exec dionysus-api python3 /app/scripts/test_heartbeat_agent.py
```

pytest.ini is configured with `asyncio_mode = auto` for async test support.

## Architecture

**Ports**: API (8000), n8n webhooks (5678), Archon local (8181)

### Core Components

```
api/
├── main.py              # FastAPI app, router registration
├── agents/              # smolagents-based cognitive agents
│   ├── heartbeat_agent.py      # OODA decision cycle (ToolCallingAgent)
│   ├── consciousness_manager.py # Orchestrates Perception/Reasoning/Metacognition
│   ├── managed/                 # ManagedAgent wrappers for sub-agents
│   ├── callbacks/               # Step callbacks (memory pruning, tracing)
│   └── tools/                   # Class-based smolagents Tools
├── services/            # Business logic
│   ├── remote_sync.py          # Graphiti-backed driver shim + n8n sync utilities
│   ├── graphiti_service.py     # Temporal knowledge graph (Graphiti)
│   └── llm_service.py          # LiteLLM router configuration
├── routers/             # FastAPI endpoints
└── models/              # Pydantic v2 models

dionysus_mcp/
├── server.py            # MCP server exposing tools to Claude
└── tools/               # MCP tool wrappers (async bridges)
```

### Agent Hierarchy

- **HeartbeatAgent**: Top-level OODA loop with `planning_interval=3` for periodic replanning
- **ConsciousnessManager**: Orchestrates three sub-agents via smolagents `managed_agents`
  - **PerceptionAgent**: OBSERVE phase - environment sensing, memory recall
  - **ReasoningAgent**: ORIENT phase - analysis, cognitive tools
  - **MetacognitionAgent**: DECIDE phase - planning, action selection

### Database Access Pattern

**CRITICAL**: Cypher access is Graphiti-backed (direct Neo4j). n8n webhooks are used for sync pipelines.

```python
# Correct - use Graphiti-backed driver shim
from api.services.remote_sync import get_neo4j_driver
driver = get_neo4j_driver()
result = await driver.execute_query(cypher, params)

# Graphiti service for temporal KG operations
from api.services.graphiti_service import get_graphiti_service
```

### Tool Pattern

Tools use class-based smolagents pattern:

```python
from smolagents import Tool

class MyTool(Tool):
    name = "my_tool"
    description = "What this tool does"
    inputs = {"param": {"type": "string", "description": "..."}}
    output_type = "string"

    def forward(self, param: str) -> str:
        # Sync method - use async_tool_wrapper for async operations
        return async_tool_wrapper(self._async_impl)()
```

## Code Style

- **Python**: 3.11+ async/await, Pydantic v2 models
- **Naming**: snake_case for functions/vars, PascalCase for classes
- **All queries**: Must be Cypher (via Graphiti-backed driver)
- **Webhooks**: Must use HMAC-SHA256 verification (`verify_memevolve_signature`)

## Architecture Constraints

- **Shell Safety**: The shell parser is sensitive to nested code (e.g., `python -c`). Use script files (`scripts/`) and sync via `git` instead of inline shell pipes.
- **Archon-First**: Archon remains local (port 8181). Dionysus receives tasks via prefetched payloads in hooks.

## Commit Guidelines

- **Authorship**: All commits must include: `AUTHOR Mani Saint-Victor, MD`
- **Style**: Conventional commits (feat, fix, refactor, etc.)
- **Avoid**: Do NOT use "Generated by Claude" or "Co-Authored-By Claude" footers

## Key Specifications

Feature specs live in `specs/{NNN}-{feature-name}/` with:
- `spec.md` - Requirements and design
- `plan.md` - Implementation approach
- `tasks.md` - Task breakdown with status

Active features:
- 038-thoughtseeds-framework: Active inference, Free Energy Engine
- 039-smolagents-v2-alignment: ManagedAgent pattern, execution traces
- 041-meta-tot-engine: MCTS-based reasoning with active inference
- 042-cognitive-tools-upgrade: D2-validated reasoning tools

## Environment Variables

Required in `.env`:
- `NEO4J_URI`, `NEO4J_PASSWORD` - Neo4j connection
- `MEMEVOLVE_HMAC_SECRET` - Webhook signature verification
- `ANTHROPIC_API_KEY` - For Graphiti extraction
- `OPENAI_API_KEY` - For smolagents orchestration
- `N8N_CYPHER_URL` - Webhook endpoint for Cypher queries
